<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>{{ title }}</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
    <script src="http://api.maps.ovi.com/jsl.js" type="text/javascript" charset="utf-8"></script>
    <script src="http://code.jquery.com/jquery-1.5.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        $("#map").css({width: $(window).width(), height: $(window).height()});
      });
    </script>
    <script src="/sm2/script/soundmanager2-nodebug-jsmin.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript">
      soundManager.url = '/sm2/swf/';
      soundManager.useHTML5Audio = true;
      soundManager.flashVersion = 9;
      soundManager.onready(function(oStatus) {
        ThoundsMap.onReady(oStatus.success);
      });
    </script>
    <script src="/javascripts/thounds_map.base.js" type="text/javascript" charset="utf-8"></script>
    <script src="/javascripts/thounds_map.ui.js" type="text/javascript" charset="utf-8"></script>
  </head>
  <body>
    <div id="wrapper">
      
    <div id="thounds_map_logo">
      <h1>{{ title }}</h1>
    </div>
    
    <div id="map" style="width:600px; height:400px;"></div>
      <script type="text/javascript">
      
        var components_collection = [
          new ovi.mapsapi.map.component.Behavior(), //behavior collection 
          new ovi.mapsapi.map.component.ZoomBar(),
          new ovi.mapsapi.map.component.Overview(),
          new ovi.mapsapi.map.component.TypeSelector(),
          new ovi.mapsapi.map.component.ScaleBar()
        ];
        
        var infobubbles = new ovi.mapsapi.map.component.InfoBubbles();
        
        var venice = [45.4375, 12.335833];
        
        var map = new ovi.mapsapi.map.Display(document.getElementById("map"), {
          components: components_collection,
          zoomLevel: 10, //zoom level for the map
          center: venice //center coordinates
        });
        
        map.addObserver("zoomLevel", function(obj, key, new_value, old_value) {
          display_thounds(null);
        });
        
        if (ovi.mapsapi.positioning.Manager) {
          var positioning = new ovi.mapsapi.positioning.Manager();
          positioning.getCurrentPosition(
            function(position) {
              var coords = position.coords;
              //var marker = new ovi.mapsapi.map.StandardMarker(coords);
              
              var marker = new ovi.mapsapi.map.Marker(
                new ovi.mapsapi.geo.Coordinate(coords.latitude, coords.longitude), {
                    title: "position",
                    visibility: true,
                    icon: "/images/youarehere.png",
                    anchor: new ovi.mapsapi.util.Point(26, 82),
                    eventListener: {}
                    }
                );
              
              var accuracyCircle = new ovi.mapsapi.map.Circle(coords, coords.accuracy);
              map.objects.addAll([accuracyCircle, marker]);
              map.setAttributes ("default", coords, 7, null, null);
              //map.zoomTo(accuracyCircle.getBoundingBox(), false, "default");
              //if (MAP1.zoomLevel > 16) MAP1.set("zoomLevel", 16); //zoom out if too close
            }
          );
        }
        
        //remove zoom.MouseWheel behavior for better page scrolling experience
        map.removeComponent(map.getComponentById("zoom.MouseWheel"));
        map.components.add(infobubbles);
        
        var markers = {};
        var thounds = {};
        
        function put_marker(thound, lat, lng) {
            if (!markers[thound.id]) {
            var m = new ovi.mapsapi.map.Marker(
                new ovi.mapsapi.geo.Coordinate(lat, lng), {
                    title: "marker",
                    visibility: true,
                    icon: "/images/thounds_pin.png",
                    anchor: new ovi.mapsapi.util.Point(16, 16),
                    eventListener: {
                        click: function(event) {
                            infobubbles.addBubble(
                            ThoundsMap.ui.createBubble(thound.id),
                            new ovi.mapsapi.geo.Coordinate(lat, lng));
                        }
                    }
                });
        
            map.objects.add(m);
            markers[thound.id] = m;
            thounds[thound.id] = thound;
            }
        }
        
        function updater(data, success) {
            for (id in markers) {
                map.objects.remove(markers[id]);
            }
            markers = {};
            thounds = {};
            if (data) {
                for (x in data) {
                    if (data[x].tracks[0].lat != null) {
                    put_marker(data[x], data[x].tracks[0].lat, data[x].tracks[0].lng);
                    }
                }
            }
        }
        
        function display_thounds(evt) {       
            var bbox = map.getViewBounds();
            var qs = "tl_lat=" + bbox.topLeft.latitude + "&tl_lng=" + bbox.topLeft.longitude + "&br_lat=" + bbox.bottomRight.latitude + "&br_lng=" + bbox.bottomRight.longitude;
            $.ajax ({
			    type: "GET",
			    url: "/get_thounds?" + qs,
			    dataType: "json",
			    cache: false, //VITAL line: the getJON func does not prevent caching!
			    success: function(data, success) {
			    	updater(data, success);
			    }
		    });
		}
        map.addListener("dragend", display_thounds, false);
        display_thounds(null);
      </script>
    </div>
  </body>
</html>